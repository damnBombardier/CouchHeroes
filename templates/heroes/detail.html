<!-- templates/heroes/detail.html (обновленный) -->
<div class="hero-quests">
    <h2>Активные квесты:</h2>
    {% if hero.quests.filter(status='in_progress').exists %}
        <ul>
        {% for heroquest in hero.quests.filter(status='in_progress') %}
            <li>
                <strong>{{ heroquest.quest.title }}</strong> - 
                Прогресс: {{ heroquest.progress }}/            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>Нет активных квестов.</p>
    {% endif %}
</div>

<div class="hero-inventory">
    <h2>Инвентарь:</h2>
    {% if hero.inventory_items.all %}
        <ul>
        {% for inv_item in hero.inventory_items.all %}
            <li>
                {{ inv_item.item.name }} (x{{ inv_item.quantity }}) - 
                <em>{{ inv_item.item.get_item_type_display }}, {{ inv_item.item.get_rarity_display }}</em>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>Инвентарь пуст.</p>
    {% endif %}
</div>

<div class="hero-log">
    <h2>Последнее действие:</h2>
    <p id="last-action">{{ last_action }}</p>
    <button onclick="refreshHero()">Обновить информацию</button>
</div>

<div class="player-actions">
    <h2>Ваше вмешательство:</h2>
    <button onclick="performAction('lightning')">Бросить молнию!</button>
    <button onclick="performAction('speech', 'Ты справишься!')">Сказать: "Ты справишься!"</button>
    <button onclick="performAction('speech', 'Беги скорее!')">Сказать: "Беги скорее!"</button>
    <button onclick="performAction('speech', 'Ищи сокровища!')">Сказать: "Ищи сокровища!"</button>
</div>

<script>
function performAction(action, message='') {
    let url = `{% url 'heroes:action' 'ACTION_PLACEHOLDER' %}`.replace('ACTION_PLACEHOLDER', action);
    if (message) {
        url += `?message=${encodeURIComponent(message)}`;
    }
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
    })
    .then(response => {
        if (!response.ok) {
             throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        alert(data.message);
        // Обновляем информацию на странице
        refreshHero();
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при выполнении действия.');
    });
}

function refreshHero() {
    // Простое обновление страницы для демонстрации
    // В реальном приложении лучше делать AJAX-запрос
    location.reload();
    
    // Альтернатива: сделать AJAX-запрос к новому endpoint
    /*
    fetch('{% url "heroes:detail_data" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        // Обновить DOM элементы
        document.getElementById('last-action').innerText = data.last_action;
        // ... обновить другие поля ...
    })
    .catch(error => console.error('Ошибка обновления:', error));
    */
}
</script>
{% csrf_token %}
{% endblock %}
